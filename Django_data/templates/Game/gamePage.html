<!DOCTYPE html>
<html>
<style>
	body {
		background-color: #f2f2f2;
		display: flex;
		flex-direction: column;
	}
	canvas {
		border: 2px solid black;
		background-color: #f2f2f2b0;
		align-self: center;
		aspect-ratio: 2/1;
		width: 90%;
		max-height: 80%;
	}
</style>
  <body>
    <center><h1>Hello , Welcome to Pong ! {{request.user}}</h1></center>
    <!-- <div
      class="chat__item__container"
      id="id_chat_item_container"
      style="font-size: 20px"
    >
      <input type="text" id="id_message_send_input" />
      <button type="submit" id="id_message_send_button">Send Message</button>
    </div> -->

	<canvas id="MyCanvas">
		<p>Description of the canvas for those unable to view it.</p>
	</canvas>
	<div id="score1div"></div>
	<div id="score2div"></div>

    <script>
		const gameSocket = new WebSocket("wss://" + window.location.host + "/wss/game/room");
		gameSocket.onopen = function (e) {
			console.log("The connection was setup successfully !");
		};
		gameSocket.onclose = function (e) {
			console.log("Something unexpected happened !");
		};
		// document.querySelector("#id_message_send_input").focus();
		// document.querySelector("#id_message_send_input").onkeyup = function (e) {
		// 	if (e.keyCode == 13) {
		// 		document.querySelector("#id_message_send_button").click();
		// 	}
		// };
		// document.querySelector("#id_message_send_button").onclick = function (e) {
		// 	var messageInput = document.querySelector(
		// 		"#id_message_send_input"
		// 	).value;
		// 	gameSocket.send(JSON.stringify({ message: messageInput, username : "{{request.user.username}}"}));
		// };
		var paddle1size = 10;
		var paddle2size = 10;
		var ballsize = 10;

		gameSocket.onmessage = function (e) {
			const data = JSON.parse(e.data);
			var score1div = document.getElementById("score1div");
			score1div.innerHTML = "Score 1 : " + data.score1;
			var score2div = document.getElementById("score2div");
			score2div.innerHTML = "Score 2 : " + data.score2;
			ballsize = data.ballsize;
			paddle1size = data.paddle1size;
			paddle2size = data.paddle2size;
			draw(data);
		};



		var canvas = document.getElementById("MyCanvas");
		var ctx = canvas.getContext("2d");


		const style = getComputedStyle(canvas);
		const width = parseInt(style.getPropertyValue('width'), 10);
		const height = parseInt(style.getPropertyValue('height'), 10);
		canvas.width = width;
		canvas.height = height;
		var paddle1Height = width/paddle1size;
		var paddle2Height = width/paddle2size;
		var ballRadius = ballsize;

		addEventListener('resize', () => {
			const style = getComputedStyle(canvas);
			const width = parseInt(style.getPropertyValue('width'), 10);
			const height = parseInt(style.getPropertyValue('height'), 10);
			canvas.width = width;
			canvas.height = height;
			paddle1Height = width/paddle1size;
			paddle2Height = width/paddle2size;
			ballRadius = ballsize;
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			draw();
		});

		function drawPaddleR(y) {
			ctx.beginPath();
			ctx.rect(canvas.width-50, y*canvas.height-paddle2Height/2, 10, paddle2Height);
			ctx.fillStyle = "#0095DD";
			ctx.fill();
			ctx.closePath();
		}

		function drawPaddleL(y) {
			ctx.beginPath();
			ctx.rect(50, y*canvas.height-paddle1Height/2, 10, paddle1Height);
			ctx.fillStyle = "#0095DD";
			ctx.fill();
			ctx.closePath();
		}

		function drawBallXY(x, y) {
			ctx.beginPath();
			ctx.arc(x*canvas.width, y*canvas.height, ballRadius, 0, Math.PI*2);
			ctx.fillStyle = "#FF95DD";
			ctx.fill();
			ctx.closePath();
		}

		function draw(data) {
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			// ctx.fillStyle = "rgba(242,242,242,0.50)";
			// ctx.fillRect(0, 0, canvas.width, canvas.height);
			drawPaddleR(data.paddleR);
			drawPaddleL(data.paddleL);
			drawBallXY(data.ballX, data.ballY);
		}

		addEventListener('keydown', (e) => {
			if (e.key === 'ArrowUp') {
				gameSocket.send(JSON.stringify({ message: "up", username : "{{request.user.username}}" }));
			}
			if (e.key === 'ArrowDown') {
				gameSocket.send(JSON.stringify({ message: "down", username : "{{request.user.username}}" }));
			}
		});
    </script>
  </body>
</html>
